{"version":3,"sources":["webpack:///./src/resources/markdown_worker.ts","webpack:///../src/rpc-wrapper.js","webpack:///./src/components/ha-markdown.ts","webpack:///./src/data/ws-templates.ts","webpack:///./src/panels/lovelace/cards/hui-markdown-card.ts"],"names":["addMethods","__webpack_require__","methods","module","exports","w","Worker","p","name","worker","c","callbacks","e","d","data","id","f","error","Object","Error","evt","document","method","Promise","a","b","type","params","customElement","HaMarkdown","property","Boolean","changedProps","_get","_getPrototypeOf","prototype","this","call","markdownWorker","_render","_callee","walker","node","regeneratorRuntime","wrap","_context","prev","next","renderMarkdown","content","breaks","gfm","tables","allowSvg","innerHTML","sent","_resize","createTreeWalker","nextNode","currentNode","HTMLAnchorElement","host","location","target","rel","addEventListener","stop","fireEvent","_this2","UpdatingElement","subscribeRenderTemplate","conn","onChange","subscribeMessage","msg","result","assign","HuiMarkdownCard","_decorate","_initialize","_LitElement","_LitElement2","_getPrototypeOf2","_this","_classCallCheck","_len","arguments","length","args","Array","_key","apply","concat","_assertThisInitialized","_inherits","F","kind","static","key","value","_getConfigElement","_asyncToGenerator","mark","all","then","bind","abrupt","createElement","decorators","undefined","_config","card_size","split","title","config","_disconnect","_hass","_connect","hass","html","_templateObject2","classMap","no-header","_content","_templateObject","oldHass","get","oldConfig","themes","theme","applyThemesOnElement","_connect2","_callee2","_this3","_context2","_unsubRenderTemplate","connection","template","entity_ids","entity_id","variables","user","_disconnect2","_callee3","unsub","_context3","t0","code","css","_templateObject3","LitElement"],"mappings":"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","file":"chunk.296c41cb183e59d64124.js","sourcesContent":["\n\t\t\t\tvar addMethods = require(\"../../node_modules/workerize-loader/dist/rpc-wrapper.js\")\n\t\t\t\tvar methods = [\"renderMarkdown\"]\n\t\t\t\tmodule.exports = function() {\n\t\t\t\t\tvar w = new Worker(__webpack_public_path__ + \"b22dc8a4ca443c74afc8.worker.js\", { name: \"[hash].worker.js\" })\n\t\t\t\t\taddMethods(w, methods)\n\t\t\t\t\t\n\t\t\t\t\treturn w\n\t\t\t\t}\n\t\t\t","export default function addMethods(worker, methods) {\n\tlet c = 0;\n\tlet callbacks = {};\n\tworker.addEventListener('message', (e) => {\n\t\tlet d = e.data;\n\t\tif (d.type!=='RPC') return;\n\t\tif (d.id) {\n\t\t\tlet f = callbacks[d.id];\n\t\t\tif (f) {\n\t\t\t\tdelete callbacks[d.id];\n\t\t\t\tif (d.error) {\n\t\t\t\t\tf[1](Object.assign(Error(d.error.message), d.error));\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tf[0](d.result);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tlet evt = document.createEvent('Event');\n\t\t\tevt.initEvent(d.method, false, false);\n\t\t\tevt.data = d.params;\n\t\t\tworker.dispatchEvent(evt);\n\t\t}\n\t});\n\tmethods.forEach( method => {\n\t\tworker[method] = (...params) => new Promise( (a, b) => {\n\t\t\tlet id = ++c;\n\t\t\tcallbacks[id] = [a, b];\n\t\t\tworker.postMessage({ type: 'RPC', id, method, params });\n\t\t});\n\t});\n}\n","import { UpdatingElement, property, customElement } from \"lit-element\";\n// eslint-disable-next-line import/no-webpack-loader-syntax\n// @ts-ignore\n// tslint:disable-next-line: no-implicit-dependencies\nimport markdownWorker from \"workerize-loader!../resources/markdown_worker\";\nimport { fireEvent } from \"../common/dom/fire_event\";\n\nlet worker: any | undefined;\n\n@customElement(\"ha-markdown\")\nclass HaMarkdown extends UpdatingElement {\n  @property() public content = \"\";\n  @property({ type: Boolean }) public allowSvg = false;\n\n  protected update(changedProps) {\n    super.update(changedProps);\n\n    if (!worker) {\n      worker = markdownWorker();\n    }\n\n    this._render();\n  }\n\n  private async _render() {\n    this.innerHTML = await worker.renderMarkdown(\n      this.content,\n      {\n        breaks: true,\n        gfm: true,\n        tables: true,\n      },\n      {\n        allowSvg: this.allowSvg,\n      }\n    );\n\n    this._resize();\n\n    const walker = document.createTreeWalker(\n      this,\n      1 /* SHOW_ELEMENT */,\n      null,\n      false\n    );\n\n    while (walker.nextNode()) {\n      const node = walker.currentNode;\n\n      // Open external links in a new window\n      if (\n        node instanceof HTMLAnchorElement &&\n        node.host !== document.location.host\n      ) {\n        node.target = \"_blank\";\n        node.rel = \"noreferrer\";\n\n        // protect referrer on external links and deny window.opener access for security reasons\n        // (see https://mathiasbynens.github.io/rel-noopener/)\n        node.rel = \"noreferrer noopener\";\n\n        // Fire a resize event when images loaded to notify content resized\n      } else if (node) {\n        node.addEventListener(\"load\", this._resize);\n      }\n    }\n  }\n\n  private _resize = () => fireEvent(this, \"iron-resize\");\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"ha-markdown\": HaMarkdown;\n  }\n}\n","import { Connection, UnsubscribeFunc } from \"home-assistant-js-websocket\";\n\ninterface RenderTemplateResult {\n  result: string;\n}\n\nexport const subscribeRenderTemplate = (\n  conn: Connection,\n  onChange: (result: string) => void,\n  params: {\n    template: string;\n    entity_ids?: string | string[];\n    variables?: object;\n  }\n): Promise<UnsubscribeFunc> => {\n  return conn.subscribeMessage(\n    (msg: RenderTemplateResult) => onChange(msg.result),\n    { type: \"render_template\", ...params }\n  );\n};\n","import {\n  html,\n  LitElement,\n  TemplateResult,\n  customElement,\n  property,\n  css,\n  CSSResult,\n  PropertyValues,\n} from \"lit-element\";\nimport { classMap } from \"lit-html/directives/class-map\";\nimport { UnsubscribeFunc } from \"home-assistant-js-websocket\";\n\nimport \"../../../components/ha-card\";\nimport \"../../../components/ha-markdown\";\n\nimport { HomeAssistant } from \"../../../types\";\nimport { LovelaceCard, LovelaceCardEditor } from \"../types\";\nimport { MarkdownCardConfig } from \"./types\";\nimport { subscribeRenderTemplate } from \"../../../data/ws-templates\";\nimport { applyThemesOnElement } from \"../../../common/dom/apply_themes_on_element\";\n\n@customElement(\"hui-markdown-card\")\nexport class HuiMarkdownCard extends LitElement implements LovelaceCard {\n  public static async getConfigElement(): Promise<LovelaceCardEditor> {\n    await import(\n      /* webpackChunkName: \"hui-markdown-card-editor\" */ \"../editor/config-elements/hui-markdown-card-editor\"\n    );\n    return document.createElement(\"hui-markdown-card-editor\");\n  }\n\n  public static getStubConfig(): MarkdownCardConfig {\n    return {\n      type: \"markdown\",\n      content:\n        \"The **Markdown** card allows you to write any text. You can style it **bold**, *italicized*, ~strikethrough~ etc. You can do images, links, and more.\\n\\nFor more information see the [Markdown Cheatsheet](https://commonmark.org/help).\",\n    };\n  }\n\n  @property() private _config?: MarkdownCardConfig;\n  @property() private _content?: string = \"\";\n  @property() private _unsubRenderTemplate?: Promise<UnsubscribeFunc>;\n  @property() private _hass?: HomeAssistant;\n\n  public getCardSize(): number {\n    return this._config === undefined\n      ? 3\n      : this._config.card_size === undefined\n      ? this._config.content.split(\"\\n\").length + (this._config.title ? 1 : 0)\n      : this._config.card_size;\n  }\n\n  public setConfig(config: MarkdownCardConfig): void {\n    if (!config.content) {\n      throw new Error(\"Invalid Configuration: Content Required\");\n    }\n\n    this._config = config;\n    this._disconnect().then(() => {\n      if (this._hass) {\n        this._connect();\n      }\n    });\n  }\n\n  public disconnectedCallback() {\n    this._disconnect();\n  }\n\n  public set hass(hass) {\n    this._hass = hass;\n    this._connect();\n  }\n\n  protected render(): TemplateResult {\n    if (!this._config) {\n      return html``;\n    }\n\n    return html`\n      <ha-card .header=\"${this._config.title}\">\n        <ha-markdown\n          class=\"markdown ${classMap({\n            \"no-header\": !this._config.title,\n          })}\"\n          .content=\"${this._content}\"\n        ></ha-markdown>\n      </ha-card>\n    `;\n  }\n\n  protected updated(changedProps: PropertyValues): void {\n    super.updated(changedProps);\n    if (!this._config || !this._hass) {\n      return;\n    }\n    const oldHass = changedProps.get(\"hass\") as HomeAssistant | undefined;\n    const oldConfig = changedProps.get(\"_config\") as\n      | MarkdownCardConfig\n      | undefined;\n\n    if (\n      !oldHass ||\n      !oldConfig ||\n      oldHass.themes !== this.hass.themes ||\n      oldConfig.theme !== this._config.theme\n    ) {\n      applyThemesOnElement(this, this._hass.themes, this._config.theme);\n    }\n  }\n\n  private async _connect() {\n    if (!this._unsubRenderTemplate && this._hass && this._config) {\n      this._unsubRenderTemplate = subscribeRenderTemplate(\n        this._hass.connection,\n        (result) => {\n          this._content = result;\n        },\n        {\n          template: this._config.content,\n          entity_ids: this._config.entity_id,\n          variables: {\n            config: this._config,\n            user: this._hass.user!.name,\n          },\n        }\n      );\n      this._unsubRenderTemplate.catch(() => {\n        this._content = this._config!.content;\n        this._unsubRenderTemplate = undefined;\n      });\n    }\n  }\n\n  private async _disconnect() {\n    if (this._unsubRenderTemplate) {\n      try {\n        const unsub = await this._unsubRenderTemplate;\n        this._unsubRenderTemplate = undefined;\n        await unsub();\n      } catch (e) {\n        if (e.code === \"not_found\") {\n          // If we get here, the connection was probably already closed. Ignore.\n        } else {\n          throw e;\n        }\n      }\n    }\n  }\n\n  static get styles(): CSSResult {\n    return css`\n      ha-markdown {\n        display: block;\n        padding: 0 16px 16px;\n        -ms-user-select: initial;\n        -webkit-user-select: initial;\n        -moz-user-select: initial;\n      }\n      .markdown.no-header {\n        padding-top: 16px;\n      }\n      ha-markdown > *:first-child {\n        margin-top: 0;\n      }\n      ha-markdown > *:last-child {\n        margin-bottom: 0;\n      }\n      ha-markdown a {\n        color: var(--primary-color);\n      }\n      ha-markdown img {\n        max-width: 100%;\n      }\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"hui-markdown-card\": HuiMarkdownCard;\n  }\n}\n"],"sourceRoot":""}