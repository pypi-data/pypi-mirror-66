{"version":3,"sources":["webpack:///./src/resources/markdown_worker.ts","webpack:///../src/rpc-wrapper.js","webpack:///./src/components/ha-markdown.ts","webpack:///./src/panels/lovelace/cards/hui-markdown-card.ts","webpack:///./src/data/ws-templates.ts"],"names":["addMethods","__webpack_require__","methods","module","exports","w","Worker","p","name","worker","c","callbacks","e","d","data","id","f","error","Object","Error","evt","document","method","Promise","a","b","type","params","customElement","HaMarkdown","_UpdatingElement","[object Object]","args","super","_initialize","this","property","Boolean","changedProps","_get","_getPrototypeOf","prototype","call","markdownWorker","_render","async","innerHTML","renderMarkdown","content","breaks","gfm","tables","allowSvg","_resize","walker","createTreeWalker","nextNode","node","currentNode","HTMLAnchorElement","host","location","target","rel","addEventListener","fireEvent","UpdatingElement","HuiMarkdownCard","_decorate","_LitElement","F","kind","static","key","value","all","then","bind","createElement","decorators","undefined","_config","card_size","split","length","title","config","_disconnect","_hass","_connect","hass","html","classMap","no-header","_content","oldHass","get","oldConfig","themes","theme","applyThemesOnElement","_unsubRenderTemplate","conn","onChange","subscribeMessage","msg","result","assign","subscribeRenderTemplate","connection","template","entity_ids","entity_id","variables","user","catch","unsub","code","css","LitElement"],"mappings":"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","file":"chunk.47ac1ca7e62eeda49d7c.js","sourcesContent":["\n\t\t\t\tvar addMethods = require(\"../../node_modules/workerize-loader/dist/rpc-wrapper.js\")\n\t\t\t\tvar methods = [\"renderMarkdown\"]\n\t\t\t\tmodule.exports = function() {\n\t\t\t\t\tvar w = new Worker(__webpack_public_path__ + \"b00f0d0b332c52e082ce.worker.js\", { name: \"[hash].worker.js\" })\n\t\t\t\t\taddMethods(w, methods)\n\t\t\t\t\t\n\t\t\t\t\treturn w\n\t\t\t\t}\n\t\t\t","export default function addMethods(worker, methods) {\n\tlet c = 0;\n\tlet callbacks = {};\n\tworker.addEventListener('message', (e) => {\n\t\tlet d = e.data;\n\t\tif (d.type!=='RPC') return;\n\t\tif (d.id) {\n\t\t\tlet f = callbacks[d.id];\n\t\t\tif (f) {\n\t\t\t\tdelete callbacks[d.id];\n\t\t\t\tif (d.error) {\n\t\t\t\t\tf[1](Object.assign(Error(d.error.message), d.error));\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tf[0](d.result);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tlet evt = document.createEvent('Event');\n\t\t\tevt.initEvent(d.method, false, false);\n\t\t\tevt.data = d.params;\n\t\t\tworker.dispatchEvent(evt);\n\t\t}\n\t});\n\tmethods.forEach( method => {\n\t\tworker[method] = (...params) => new Promise( (a, b) => {\n\t\t\tlet id = ++c;\n\t\t\tcallbacks[id] = [a, b];\n\t\t\tworker.postMessage({ type: 'RPC', id, method, params });\n\t\t});\n\t});\n}\n","import { UpdatingElement, property, customElement } from \"lit-element\";\n// eslint-disable-next-line import/no-webpack-loader-syntax\n// @ts-ignore\n// tslint:disable-next-line: no-implicit-dependencies\nimport markdownWorker from \"workerize-loader!../resources/markdown_worker\";\nimport { fireEvent } from \"../common/dom/fire_event\";\n\nlet worker: any | undefined;\n\n@customElement(\"ha-markdown\")\nclass HaMarkdown extends UpdatingElement {\n  @property() public content = \"\";\n  @property({ type: Boolean }) public allowSvg = false;\n\n  protected update(changedProps) {\n    super.update(changedProps);\n\n    if (!worker) {\n      worker = markdownWorker();\n    }\n\n    this._render();\n  }\n\n  private async _render() {\n    this.innerHTML = await worker.renderMarkdown(\n      this.content,\n      {\n        breaks: true,\n        gfm: true,\n        tables: true,\n      },\n      {\n        allowSvg: this.allowSvg,\n      }\n    );\n\n    this._resize();\n\n    const walker = document.createTreeWalker(\n      this,\n      1 /* SHOW_ELEMENT */,\n      null,\n      false\n    );\n\n    while (walker.nextNode()) {\n      const node = walker.currentNode;\n\n      // Open external links in a new window\n      if (\n        node instanceof HTMLAnchorElement &&\n        node.host !== document.location.host\n      ) {\n        node.target = \"_blank\";\n        node.rel = \"noreferrer\";\n\n        // protect referrer on external links and deny window.opener access for security reasons\n        // (see https://mathiasbynens.github.io/rel-noopener/)\n        node.rel = \"noreferrer noopener\";\n\n        // Fire a resize event when images loaded to notify content resized\n      } else if (node) {\n        node.addEventListener(\"load\", this._resize);\n      }\n    }\n  }\n\n  private _resize = () => fireEvent(this, \"iron-resize\");\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"ha-markdown\": HaMarkdown;\n  }\n}\n","import {\n  html,\n  LitElement,\n  TemplateResult,\n  customElement,\n  property,\n  css,\n  CSSResult,\n  PropertyValues,\n} from \"lit-element\";\nimport { classMap } from \"lit-html/directives/class-map\";\nimport { UnsubscribeFunc } from \"home-assistant-js-websocket\";\n\nimport \"../../../components/ha-card\";\nimport \"../../../components/ha-markdown\";\n\nimport { HomeAssistant } from \"../../../types\";\nimport { LovelaceCard, LovelaceCardEditor } from \"../types\";\nimport { MarkdownCardConfig } from \"./types\";\nimport { subscribeRenderTemplate } from \"../../../data/ws-templates\";\nimport { applyThemesOnElement } from \"../../../common/dom/apply_themes_on_element\";\n\n@customElement(\"hui-markdown-card\")\nexport class HuiMarkdownCard extends LitElement implements LovelaceCard {\n  public static async getConfigElement(): Promise<LovelaceCardEditor> {\n    await import(\n      /* webpackChunkName: \"hui-markdown-card-editor\" */ \"../editor/config-elements/hui-markdown-card-editor\"\n    );\n    return document.createElement(\"hui-markdown-card-editor\");\n  }\n\n  public static getStubConfig(): MarkdownCardConfig {\n    return {\n      type: \"markdown\",\n      content:\n        \"The **Markdown** card allows you to write any text. You can style it **bold**, *italicized*, ~strikethrough~ etc. You can do images, links, and more.\\n\\nFor more information see the [Markdown Cheatsheet](https://commonmark.org/help).\",\n    };\n  }\n\n  @property() private _config?: MarkdownCardConfig;\n  @property() private _content?: string = \"\";\n  @property() private _unsubRenderTemplate?: Promise<UnsubscribeFunc>;\n  @property() private _hass?: HomeAssistant;\n\n  public getCardSize(): number {\n    return this._config === undefined\n      ? 3\n      : this._config.card_size === undefined\n      ? this._config.content.split(\"\\n\").length + (this._config.title ? 1 : 0)\n      : this._config.card_size;\n  }\n\n  public setConfig(config: MarkdownCardConfig): void {\n    if (!config.content) {\n      throw new Error(\"Invalid Configuration: Content Required\");\n    }\n\n    this._config = config;\n    this._disconnect().then(() => {\n      if (this._hass) {\n        this._connect();\n      }\n    });\n  }\n\n  public disconnectedCallback() {\n    this._disconnect();\n  }\n\n  public set hass(hass) {\n    this._hass = hass;\n    this._connect();\n  }\n\n  protected render(): TemplateResult {\n    if (!this._config) {\n      return html``;\n    }\n\n    return html`\n      <ha-card .header=\"${this._config.title}\">\n        <ha-markdown\n          class=\"markdown ${classMap({\n            \"no-header\": !this._config.title,\n          })}\"\n          .content=\"${this._content}\"\n        ></ha-markdown>\n      </ha-card>\n    `;\n  }\n\n  protected updated(changedProps: PropertyValues): void {\n    super.updated(changedProps);\n    if (!this._config || !this._hass) {\n      return;\n    }\n    const oldHass = changedProps.get(\"hass\") as HomeAssistant | undefined;\n    const oldConfig = changedProps.get(\"_config\") as\n      | MarkdownCardConfig\n      | undefined;\n\n    if (\n      !oldHass ||\n      !oldConfig ||\n      oldHass.themes !== this.hass.themes ||\n      oldConfig.theme !== this._config.theme\n    ) {\n      applyThemesOnElement(this, this._hass.themes, this._config.theme);\n    }\n  }\n\n  private async _connect() {\n    if (!this._unsubRenderTemplate && this._hass && this._config) {\n      this._unsubRenderTemplate = subscribeRenderTemplate(\n        this._hass.connection,\n        (result) => {\n          this._content = result;\n        },\n        {\n          template: this._config.content,\n          entity_ids: this._config.entity_id,\n          variables: {\n            config: this._config,\n            user: this._hass.user!.name,\n          },\n        }\n      );\n      this._unsubRenderTemplate.catch(() => {\n        this._content = this._config!.content;\n        this._unsubRenderTemplate = undefined;\n      });\n    }\n  }\n\n  private async _disconnect() {\n    if (this._unsubRenderTemplate) {\n      try {\n        const unsub = await this._unsubRenderTemplate;\n        this._unsubRenderTemplate = undefined;\n        await unsub();\n      } catch (e) {\n        if (e.code === \"not_found\") {\n          // If we get here, the connection was probably already closed. Ignore.\n        } else {\n          throw e;\n        }\n      }\n    }\n  }\n\n  static get styles(): CSSResult {\n    return css`\n      ha-markdown {\n        display: block;\n        padding: 0 16px 16px;\n        -ms-user-select: initial;\n        -webkit-user-select: initial;\n        -moz-user-select: initial;\n      }\n      .markdown.no-header {\n        padding-top: 16px;\n      }\n      ha-markdown > *:first-child {\n        margin-top: 0;\n      }\n      ha-markdown > *:last-child {\n        margin-bottom: 0;\n      }\n      ha-markdown a {\n        color: var(--primary-color);\n      }\n      ha-markdown img {\n        max-width: 100%;\n      }\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"hui-markdown-card\": HuiMarkdownCard;\n  }\n}\n","import { Connection, UnsubscribeFunc } from \"home-assistant-js-websocket\";\n\ninterface RenderTemplateResult {\n  result: string;\n}\n\nexport const subscribeRenderTemplate = (\n  conn: Connection,\n  onChange: (result: string) => void,\n  params: {\n    template: string;\n    entity_ids?: string | string[];\n    variables?: object;\n  }\n): Promise<UnsubscribeFunc> => {\n  return conn.subscribeMessage(\n    (msg: RenderTemplateResult) => onChange(msg.result),\n    { type: \"render_template\", ...params }\n  );\n};\n"],"sourceRoot":""}